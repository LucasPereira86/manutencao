<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>Dashboard - Manuten√ß√£o de Campo</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .fleet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .fleet-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            border-left: 4px solid var(--text-muted);
        }

        .fleet-card:hover {
            background: var(--bg-card-hover);
        }

        .fleet-card.status-ok {
            border-left-color: var(--status-ok);
        }

        .fleet-card.status-warning {
            border-left-color: var(--status-warning);
        }

        .fleet-card.status-danger {
            border-left-color: var(--status-danger);
        }

        .fleet-card.status-pending {
            border-left-color: var(--text-muted);
        }

        .fleet-icon {
            font-size: 2rem;
            width: 48px;
            text-align: center;
        }

        .fleet-info {
            flex: 1;
        }

        .fleet-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .fleet-last {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .fleet-status {
            text-align: right;
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: none;
            border-radius: 50px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }

        .filter-tab.active {
            background: var(--accent-primary);
            color: white;
        }

        .history-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .history-machine {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-problems {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--bg-secondary);
        }

        .problem-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .problem-item .icon {
            color: var(--status-danger);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div>
                <h1 class="app-title">Dashboard</h1>
                <p class="app-subtitle">Vis√£o geral da frota</p>
            </div>
            <button id="btnTema" onclick="App.toggleTema()"
                style="padding: 0.5rem 0.75rem; background: var(--accent-primary); color: #fff; border: none; border-radius: var(--radius-sm); font-size: 0.8rem; cursor: pointer;">Escuro</button>
        </header>

        <!-- Estat√≠sticas -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-value ok" id="statOk">0</div>
                <div class="stat-label">OK Hoje</div>
            </div>
            <div class="stat-card">
                <div class="stat-value danger" id="statProblemas">0</div>
                <div class="stat-label">Com Problemas</div>
            </div>
            <div class="stat-card">
                <div class="stat-value warning" id="statPendentes">0</div>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">Total Checklists</div>
            </div>
        </section>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="trocarAba('frota', this)">Frota</div>
            <div class="tab" onclick="trocarAba('historico', this)">Hist√≥rico</div>
        </div>

        <!-- Aba Frota -->
        <section id="abaFrota">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filtrarFrota('todos', this)" id="filtroTodos">Todos</button>
                <button class="filter-tab" onclick="filtrarFrota('colhedora', this)"
                    id="filtroColhedoras">Colhedoras</button>
                <button class="filter-tab" onclick="filtrarFrota('trator', this)" id="filtroTratores">Tratores</button>
                <button class="filter-tab" onclick="filtrarFrota('transbordo', this)"
                    id="filtroTransbordos">Transbordos</button>
            </div>

            <div id="listaFrota">
                <!-- Preenchido via JS -->
            </div>
        </section>

        <!-- Aba Hist√≥rico -->
        <section id="abaHistorico" class="hidden">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filtrarHistorico('hoje', this)">Hoje</button>
                <button class="filter-tab" onclick="filtrarHistorico('semana', this)">√öltima Semana</button>
                <button class="filter-tab" onclick="filtrarHistorico('mes', this)">√öltimo M√™s</button>
                <button class="filter-tab" onclick="filtrarHistorico('todos', this)">Todos</button>
            </div>

            <div id="listaHistorico">
                <!-- Preenchido via JS -->
            </div>
        </section>

        <!-- Navega√ß√£o Inferior -->
        <nav class="bottom-nav">
            <a href="../index.html" class="nav-item">
                <span class="nav-label">In√≠cio</span>
            </a>
            <a href="checklist.html" class="nav-item">
                <span class="nav-label">Checklist</span>
            </a>
            <a href="dashboard.html" class="nav-item active">
                <span class="nav-label">Dashboard</span>
            </a>
            <a href="diagnostico.html" class="nav-item">
                <span class="nav-label">Diagn√≥stico</span>
            </a>
        </nav>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal-overlay" id="modalDetalhes">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitulo">Detalhes</h3>
                <button class="modal-close" onclick="fecharModal()">‚úï</button>
            </div>
            <div id="modalConteudo">
                <!-- Preenchido via JS -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="../js/db.js"></script>
    <script src="../js/app.js"></script>
    <script>
        let todosChecklists = [];
        let statusMaquinas = {};

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            await DB.init();
            await carregarDados();
        });

        async function carregarDados() {
            todosChecklists = await DB.buscarChecklists();
            calcularStatusMaquinas();
            atualizarEstatisticas();
            renderizarFrota();
            renderizarHistorico('hoje');
        }

        function calcularStatusMaquinas() {
            statusMaquinas = {};
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            // Inicializa todas as m√°quinas como pendentes
            App.TODAS_MAQUINAS.forEach(m => {
                statusMaquinas[m.id] = {
                    maquina: m,
                    status: 'pending',
                    ultimoChecklist: null,
                    problemas: []
                };
            });

            // Atualiza com dados dos checklists de hoje
            todosChecklists.forEach(c => {
                const dataChecklist = new Date(c.data);
                dataChecklist.setHours(0, 0, 0, 0);

                if (dataChecklist.getTime() === hoje.getTime()) {
                    const temProblema = c.itens && c.itens.some(i => i.status === 'problema');
                    const problemas = c.itens ? c.itens.filter(i => i.status === 'problema') : [];

                    statusMaquinas[c.maquina] = {
                        ...statusMaquinas[c.maquina],
                        status: temProblema ? 'danger' : 'ok',
                        ultimoChecklist: c,
                        problemas
                    };
                } else if (!statusMaquinas[c.maquina].ultimoChecklist) {
                    // Guarda √∫ltimo checklist se n√£o houver de hoje
                    statusMaquinas[c.maquina].ultimoChecklist = c;
                }
            });
        }

        function atualizarEstatisticas() {
            let ok = 0, problemas = 0, pendentes = 0;

            Object.values(statusMaquinas).forEach(s => {
                if (s.status === 'ok') ok++;
                else if (s.status === 'danger') problemas++;
                else pendentes++;
            });

            document.getElementById('statOk').textContent = ok;
            document.getElementById('statProblemas').textContent = problemas;
            document.getElementById('statPendentes').textContent = pendentes;
            document.getElementById('statTotal').textContent = todosChecklists.length;
        }

        function renderizarFrota(filtroTipo = 'todos') {
            const container = document.getElementById('listaFrota');
            container.innerHTML = '';

            const maquinasFiltradas = filtroTipo === 'todos'
                ? App.TODAS_MAQUINAS
                : App.TODAS_MAQUINAS.filter(m => m.tipo === filtroTipo);

            // Ordena: problemas primeiro, depois pendentes, depois ok
            const ordenacao = { danger: 0, warning: 1, pending: 2, ok: 3 };
            maquinasFiltradas.sort((a, b) => {
                const statusA = statusMaquinas[a.id]?.status || 'pending';
                const statusB = statusMaquinas[b.id]?.status || 'pending';
                return ordenacao[statusA] - ordenacao[statusB];
            });

            maquinasFiltradas.forEach(m => {
                const status = statusMaquinas[m.id] || { status: 'pending' };
                const card = document.createElement('div');
                card.className = `fleet-card status-${status.status}`;
                card.onclick = () => abrirDetalhes(m.id);

                let ultimaData = 'Sem checklist';
                if (status.ultimoChecklist) {
                    ultimaData = App.isHoje(status.ultimoChecklist.data)
                        ? 'Hoje ' + new Date(status.ultimoChecklist.data).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                        : App.formatarDataCurta(status.ultimoChecklist.data);
                }

                const statusBadge = {
                    ok: '<span class="status-badge ok">‚úì OK</span>',
                    danger: `<span class="status-badge danger">‚ö†Ô∏è ${status.problemas.length} problema${status.problemas.length > 1 ? 's' : ''}</span>`,
                    pending: '<span class="status-badge warning">Pendente</span>'
                };

                card.innerHTML = `
          <div class="fleet-icon">${App.getIconeMaquina(m.tipo)}</div>
          <div class="fleet-info">
            <div class="fleet-name">${m.nome}</div>
            <div class="fleet-last">√öltimo: ${ultimaData}</div>
          </div>
          <div class="fleet-status">
            ${statusBadge[status.status] || statusBadge.pending}
          </div>
        `;

                container.appendChild(card);
            });

            if (maquinasFiltradas.length === 0) {
                container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üîç</div>
            <h3>Nenhuma m√°quina encontrada</h3>
          </div>
        `;
            }
        }

        function renderizarHistorico(periodo) {
            const container = document.getElementById('listaHistorico');
            container.innerHTML = '';

            const agora = new Date();
            let dataLimite = new Date();

            switch (periodo) {
                case 'hoje':
                    dataLimite.setHours(0, 0, 0, 0);
                    break;
                case 'semana':
                    dataLimite.setDate(dataLimite.getDate() - 7);
                    break;
                case 'mes':
                    dataLimite.setMonth(dataLimite.getMonth() - 1);
                    break;
                default:
                    dataLimite = new Date(0);
            }

            const checklistsFiltrados = todosChecklists.filter(c =>
                new Date(c.data) >= dataLimite
            );

            if (checklistsFiltrados.length === 0) {
                container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üìã</div>
            <h3>Nenhum checklist encontrado</h3>
            <p>N√£o h√° registros para este per√≠odo</p>
          </div>
        `;
                return;
            }

            checklistsFiltrados.forEach(c => {
                const temProblema = c.itens && c.itens.some(i => i.status === 'problema');
                const problemas = c.itens ? c.itens.filter(i => i.status === 'problema') : [];
                const maquina = App.buscarMaquina(c.maquina);

                const card = document.createElement('div');
                card.className = 'history-card';
                card.onclick = () => abrirDetalhesChecklist(c);

                card.innerHTML = `
          <div class="history-header">
            <div class="history-machine">
              <span>${App.getIconeMaquina(maquina?.tipo || c.tipo)}</span>
              <strong>${c.maquinaNome || c.maquina}</strong>
            </div>
            <span class="status-badge ${temProblema ? 'danger' : 'ok'}">
              ${temProblema ? `‚ö†Ô∏è ${problemas.length}` : '‚úì OK'}
            </span>
          </div>
          <div class="fleet-last">
            üìÖ ${App.formatarData(c.data)}
          </div>
          ${problemas.length > 0 ? `
            <div class="history-problems">
              ${problemas.slice(0, 3).map(p => `
                <div class="problem-item">
                  <span class="icon">‚ö†Ô∏è</span>
                  <span>${p.id}: ${p.obs || 'Sem descri√ß√£o'}</span>
                </div>
              `).join('')}
              ${problemas.length > 3 ? `<small class="text-muted">+ ${problemas.length - 3} mais...</small>` : ''}
            </div>
          ` : ''}
        `;

                container.appendChild(card);
            });
        }

        function trocarAba(aba, elemento) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            elemento.classList.add('active');

            document.getElementById('abaFrota').classList.toggle('hidden', aba !== 'frota');
            document.getElementById('abaHistorico').classList.toggle('hidden', aba !== 'historico');
        }

        function filtrarFrota(tipo, elemento) {
            document.querySelectorAll('#abaFrota .filter-tab').forEach(t => t.classList.remove('active'));
            elemento.classList.add('active');
            renderizarFrota(tipo);
        }

        function filtrarHistorico(periodo, elemento) {
            document.querySelectorAll('#abaHistorico .filter-tab').forEach(t => t.classList.remove('active'));
            elemento.classList.add('active');
            renderizarHistorico(periodo);
        }

        function abrirDetalhes(maquinaId) {
            const status = statusMaquinas[maquinaId];
            if (!status) return;

            document.getElementById('modalTitulo').textContent = status.maquina.nome;

            let conteudo = `
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <span style="font-size: 3rem;">${App.getIconeMaquina(status.maquina.tipo)}</span>
          <h4 style="margin-top: 0.5rem;">${status.maquina.modelo}</h4>
        </div>
      `;

            if (status.ultimoChecklist) {
                const temProblema = status.status === 'danger';
                conteudo += `
          <div class="card" style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>√öltimo Checklist</span>
              <span class="status-badge ${temProblema ? 'danger' : 'ok'}">
                ${temProblema ? '‚ö†Ô∏è Problemas' : '‚úì OK'}
              </span>
            </div>
            <div class="fleet-last mt-1">
              üìÖ ${App.formatarData(status.ultimoChecklist.data)}
            </div>
          </div>
        `;

                if (status.problemas.length > 0) {
                    conteudo += `
            <h4 class="section-title">‚ö†Ô∏è Problemas Encontrados</h4>
            ${status.problemas.map(p => `
              <div class="checklist-item">
                <div class="checklist-checkbox problem">
                  <span class="check-icon" style="opacity: 1;">!</span>
                </div>
                <div class="checklist-content">
                  <div class="checklist-title">${p.id}</div>
                  ${p.obs ? `<div class="checklist-description">${p.obs}</div>` : ''}
                </div>
              </div>
            `).join('')}
          `;
                }
            } else {
                conteudo += `
          <div class="empty-state">
            <div class="icon">üìã</div>
            <h3>Sem checklist hoje</h3>
            <p>Esta m√°quina ainda n√£o foi inspecionada</p>
          </div>
        `;
            }

            conteudo += `
        <a href="checklist.html" class="btn btn-primary btn-block mt-2">
          üìã Fazer Checklist
        </a>
      `;

            document.getElementById('modalConteudo').innerHTML = conteudo;
            document.getElementById('modalDetalhes').classList.add('active');
        }

        function abrirDetalhesChecklist(checklist) {
            const maquina = App.buscarMaquina(checklist.maquina);
            document.getElementById('modalTitulo').textContent = checklist.maquinaNome;

            const problemas = checklist.itens ? checklist.itens.filter(i => i.status === 'problema') : [];
            const oks = checklist.itens ? checklist.itens.filter(i => i.status === 'ok') : [];

            let conteudo = `
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <span style="font-size: 3rem;">${App.getIconeMaquina(maquina?.tipo || checklist.tipo)}</span>
          <div class="fleet-last mt-1">üìÖ ${App.formatarData(checklist.data)}</div>
        </div>
        
        <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
          <div class="stat-card">
            <div class="stat-value ok">${oks.length}</div>
            <div class="stat-label">OK</div>
          </div>
          <div class="stat-card">
            <div class="stat-value danger">${problemas.length}</div>
            <div class="stat-label">Problemas</div>
          </div>
        </div>
      `;

            if (problemas.length > 0) {
                conteudo += `
          <h4 class="section-title mt-2">‚ö†Ô∏è Problemas</h4>
          ${problemas.map(p => `
            <div class="checklist-item">
              <div class="checklist-checkbox problem">
                <span class="check-icon" style="opacity: 1;">!</span>
              </div>
              <div class="checklist-content">
                <div class="checklist-title">${p.id}</div>
                ${p.obs ? `<div class="checklist-description">${p.obs}</div>` : ''}
              </div>
            </div>
          `).join('')}
        `;
            }

            if (checklist.observacoesGerais) {
                conteudo += `
          <h4 class="section-title mt-2">üìù Observa√ß√µes Gerais</h4>
          <div class="card">
            ${checklist.observacoesGerais}
          </div>
        `;
            }

            document.getElementById('modalConteudo').innerHTML = conteudo;
            document.getElementById('modalDetalhes').classList.add('active');
        }

        function fecharModal() {
            document.getElementById('modalDetalhes').classList.remove('active');
        }
    </script>
</body>

</html>