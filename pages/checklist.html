<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#16213e">
    <title>Checklist - Manuten√ß√£o de Campo</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .pending-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--status-warning);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .machine-card {
            position: relative;
        }

        .history-section {
            margin-top: 2rem;
        }

        .history-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .history-item:hover {
            transform: translateX(5px);
        }

        .history-info h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
        }

        .history-info p {
            margin: 0;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .history-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-print {
            background: var(--accent-secondary);
            color: #fff;
        }

        .btn-edit {
            background: var(--status-warning);
            color: #000;
        }

        .btn-delete {
            background: var(--status-danger);
            color: #fff;
        }

        .print-modal {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .print-content {
            background: #fff;
            color: #000;
            padding: 2rem;
            border-radius: 8px;
        }

        .print-content h1 {
            color: #16213e;
            margin-bottom: 0.5rem;
        }

        .print-content h2 {
            color: #1a1a2e;
            font-size: 1.1rem;
            margin: 1.5rem 0 0.5rem;
            border-bottom: 2px solid #16213e;
            padding-bottom: 0.25rem;
        }

        .print-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .print-item .status {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-weight: bold;
        }

        .print-item .status.ok {
            background: #10b981;
            color: #fff;
        }

        .print-item .status.problema {
            background: #ef4444;
            color: #fff;
        }

        .print-item .status.pendente {
            background: #6b7280;
            color: #fff;
        }

        .print-item .obs {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            margin-left: 2rem;
        }

        .print-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .print-header-info {
            font-size: 0.9rem;
            color: #666;
        }

        @media print {

            /* Preservar cores */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            /* Esconder TUDO da p√°gina */
            html,
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                height: auto !important;
                overflow: visible !important;
            }

            .app-container,
            .app-header,
            .bottom-nav,
            #etapa1,
            #etapa2,
            #etapa3,
            #modalFoto,
            #modalObs,
            .auto-save-indicator,
            .toast-container {
                display: none !important;
            }

            /* Mostrar apenas o modal de impress√£o */
            #modalPrint {
                display: block !important;
                position: static !important;
                background: white !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            #modalPrint .modal {
                display: block !important;
                position: static !important;
                width: 100% !important;
                max-width: none !important;
                max-height: none !important;
                height: auto !important;
                overflow: visible !important;
                background: white !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }

            /* Esconder cabe√ßalho e bot√µes do modal */
            #modalPrint .modal-header,
            #modalPrint .modal button,
            #modalPrint .modal .mt-2:last-of-type {
                display: none !important;
            }

            /* Conte√∫do de impress√£o */
            .print-content {
                display: block !important;
                position: static !important;
                width: 100% !important;
                max-width: none !important;
                background: white !important;
                color: black !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 11pt !important;
                line-height: 1.4 !important;
            }

            .print-content h1 {
                font-size: 16pt !important;
                color: #16213e !important;
                margin-bottom: 0.5rem !important;
            }

            .print-content h2 {
                font-size: 13pt !important;
                color: #1a1a2e !important;
                margin: 1rem 0 0.5rem !important;
                padding-bottom: 0.25rem !important;
                border-bottom: 2px solid #16213e !important;
                page-break-after: avoid !important;
            }

            .print-content h3 {
                font-size: 11pt !important;
                page-break-after: avoid !important;
            }

            /* Itens do checklist */
            .print-item {
                page-break-inside: avoid !important;
                margin-bottom: 0.5rem !important;
            }

            .print-item .status {
                min-width: 24px !important;
                min-height: 24px !important;
            }

            .print-item .status.ok {
                background: #10b981 !important;
                color: white !important;
            }

            .print-item .status.problema {
                background: #ef4444 !important;
                color: white !important;
            }

            .print-item .status.pendente {
                background: #6b7280 !important;
                color: white !important;
            }

            /* Fotos */
            .print-photos,
            .print-content img {
                page-break-inside: avoid !important;
            }

            .print-content img {
                max-width: 280px !important;
                height: auto !important;
            }

            /* Rodap√© com assinaturas */
            .print-footer {
                page-break-inside: avoid !important;
                margin-top: 1.5rem !important;
            }

            /* Configura√ß√£o da p√°gina */
            @page {
                size: A4 portrait;
                margin: 10mm 15mm;
            }
        }

        .auto-save-indicator {
            position: fixed;
            bottom: 80px;
            right: 1rem;
            background: var(--status-success);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div>
                <h1 class="app-title">üìã Checklist</h1>
                <p class="app-subtitle">Inspe√ß√£o di√°ria de m√°quinas</p>
            </div>
        </header>

        <!-- Etapa 1: Sele√ß√£o de Tipo de M√°quina -->
        <section id="etapa1">
            <h3 class="section-title">Selecione o tipo de m√°quina</h3>

            <div class="grid-3" id="tiposMaquinas">
                <div class="machine-card" onclick="selecionarTipo('colhedora')">
                    <div class="machine-icon">üöú</div>
                    <div class="machine-name">Colhedora</div>
                    <div class="machine-status">
                        <span class="status-badge info" id="qtdColhedoras">-</span>
                    </div>
                </div>

                <div class="machine-card" onclick="selecionarTipo('trator')">
                    <div class="machine-icon">üöõ</div>
                    <div class="machine-name">Trator</div>
                    <div class="machine-status">
                        <span class="status-badge info" id="qtdTratores">-</span>
                    </div>
                </div>

                <div class="machine-card" onclick="selecionarTipo('transbordo')">
                    <div class="machine-icon">üöö</div>
                    <div class="machine-name">Transbordo</div>
                    <div class="machine-status">
                        <span class="status-badge info" id="qtdTransbordos">-</span>
                    </div>
                </div>
            </div>

            <div class="mt-2 text-center">
                <a href="frota.html" style="color: var(--accent-secondary); font-size: 0.9rem;">
                    ‚öôÔ∏è Gerenciar m√°quinas
                </a>
            </div>

            <!-- Hist√≥rico de Checklists -->
            <div class="history-section" id="historicoSection">
                <h3 class="section-title">üìú Hist√≥rico</h3>
                <div id="listaHistorico">
                    <!-- Preenchido via JS -->
                </div>
            </div>
        </section>

        <!-- Etapa 2: Sele√ß√£o de M√°quina Espec√≠fica -->
        <section id="etapa2" class="hidden">
            <button class="back-btn" onclick="voltarEtapa(1)">
                ‚Üê Voltar
            </button>

            <h3 class="section-title" id="tituloMaquinas">Selecione a m√°quina</h3>

            <div id="listaMaquinas" class="grid-2">
                <!-- Preenchido via JS -->
            </div>
        </section>

        <!-- Etapa 3: Checklist -->
        <section id="etapa3" class="hidden">
            <button class="back-btn" onclick="voltarEtapa(2)">
                ‚Üê Voltar
            </button>

            <div class="card" style="background: var(--accent-gradient); margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-size: 2.5rem;" id="iconeMaquinaSelecionada">üöú</span>
                    <div>
                        <h2 style="font-size: 1.25rem; margin-bottom: 0.25rem;" id="nomeMaquinaSelecionada">Colhedora 01
                        </h2>
                        <p style="opacity: 0.8; font-size: 0.9rem;" id="modeloMaquinaSelecionada">CH570</p>
                        <p style="opacity: 0.6; font-size: 0.75rem;" id="modoEdicao"></p>
                    </div>
                </div>
            </div>

            <div id="progressoChecklist" class="card" style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Progresso</span>
                    <span id="progressoTexto">0 / 0</span>
                </div>
                <div style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                    <div id="progressoBarra"
                        style="height: 100%; background: var(--accent-gradient); width: 0%; transition: width 0.3s;">
                    </div>
                </div>
            </div>

            <div id="categoriasChecklist">
                <!-- Preenchido via JS -->
            </div>

            <div class="form-group mt-3">
                <label class="form-label">Observa√ß√µes Gerais</label>
                <textarea id="observacoesGerais" class="form-textarea"
                    placeholder="Descreva observa√ß√µes adicionais..."></textarea>
            </div>

            <div class="mt-3" style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="salvarRascunhoManual()">
                    üíæ Salvar Rascunho
                </button>
                <button class="btn btn-success" style="flex: 2;" onclick="finalizarChecklist()">
                    ‚úÖ Finalizar
                </button>
            </div>
        </section>

        <!-- Navega√ß√£o Inferior -->
        <nav class="bottom-nav">
            <a href="../index.html" class="nav-item">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">In√≠cio</span>
            </a>
            <a href="checklist.html" class="nav-item active">
                <span class="nav-icon">üìã</span>
                <span class="nav-label">Checklist</span>
            </a>
            <a href="dashboard.html" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Dashboard</span>
            </a>
            <a href="diagnostico.html" class="nav-item">
                <span class="nav-icon">üîç</span>
                <span class="nav-label">Diagn√≥stico</span>
            </a>
        </nav>
    </div>

    <!-- Indicador de Auto-Save -->
    <div class="auto-save-indicator" id="autoSaveIndicator">üíæ Salvo automaticamente</div>

    <!-- Modal de Foto -->
    <div class="modal-overlay" id="modalFoto">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üì∏ Adicionar Foto</h3>
                <button class="modal-close" onclick="fecharModalFoto()">‚úï</button>
            </div>
            <div class="photo-capture">
                <div class="photo-preview" id="fotoPreview">
                    <span>Nenhuma foto</span>
                </div>
                <button class="btn btn-primary btn-block" onclick="tirarFoto()">
                    üì∑ Tirar Foto
                </button>
            </div>
            <div class="form-group mt-2">
                <label class="form-label">Descri√ß√£o da foto</label>
                <input type="text" class="form-input" id="fotoDescricao" placeholder="Ex: Vazamento no cilindro">
            </div>
            <div class="mt-2" style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="fecharModalFoto()">Cancelar</button>
                <button class="btn btn-success" style="flex: 1;" onclick="salvarFoto()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Observa√ß√£o -->
    <div class="modal-overlay" id="modalObs">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üìù Observa√ß√£o</h3>
                <button class="modal-close" onclick="fecharModalObs()">‚úï</button>
            </div>
            <div class="form-group">
                <label class="form-label" id="labelItemObs">Item</label>
                <textarea class="form-textarea" id="textoObs"
                    placeholder="Descreva o problema ou observa√ß√£o..."></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="fecharModalObs()">Cancelar</button>
                <button class="btn btn-success" style="flex: 1;" onclick="salvarObs()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Impress√£o/Visualiza√ß√£o -->
    <div class="modal-overlay" id="modalPrint">
        <div class="modal print-modal">
            <div class="modal-header">
                <h3 class="modal-title">üìÑ Visualizar Checklist</h3>
                <button class="modal-close" onclick="fecharModalPrint()">‚úï</button>
            </div>
            <div class="print-content" id="printContent">
                <!-- Conte√∫do preenchido via JS -->
            </div>
            <div class="mt-2" style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="fecharModalPrint()">Fechar</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="window.print()">üñ®Ô∏è Imprimir</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="../js/db.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/checklist.js"></script>
    <script>
        // Estado do checklist
        let tipoSelecionado = null;
        let maquinaSelecionada = null;
        let itensChecklist = {};
        let fotosChecklist = [];
        let itemFotoAtual = null;
        let itemObsAtual = null;
        let fotoAtualBase64 = null;
        let modoEdicaoId = null; // ID do checklist sendo editado
        let autoSaveTimer = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            await DB.init();
            atualizarContadores();
            carregarHistorico();
        });

        // Atualiza contadores de m√°quinas
        function atualizarContadores() {
            const frota = App.getMaquinas();
            document.getElementById('qtdColhedoras').textContent = (frota.colhedoras?.length || 0) + ' unid.';
            document.getElementById('qtdTratores').textContent = (frota.tratores?.length || 0) + ' unid.';
            document.getElementById('qtdTransbordos').textContent = (frota.transbordos?.length || 0) + ' unid.';
        }

        // Carrega hist√≥rico de checklists
        async function carregarHistorico() {
            const checklists = await DB.buscarChecklists();
            const container = document.getElementById('listaHistorico');

            if (checklists.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.6;">Nenhum checklist realizado ainda</p>';
                return;
            }

            // Mostra √∫ltimos 10
            container.innerHTML = checklists.slice(0, 10).map(c => {
                const data = new Date(c.data);
                const problemas = c.itens?.filter(i => i.status === 'problema').length || 0;
                return `
                    <div class="history-item">
                        <div class="history-info">
                            <h4>${App.getIconeMaquina(c.tipo)} ${c.maquinaNome}</h4>
                            <p>${data.toLocaleDateString('pt-BR')} √†s ${data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} 
                               ${problemas > 0 ? `‚Ä¢ <span style="color: var(--status-danger);">${problemas} problema(s)</span>` : '‚Ä¢ ‚úÖ OK'}</p>
                        </div>
                        <div class="history-actions">
                            <button class="btn-icon btn-print" onclick="event.stopPropagation(); visualizarChecklist(${c.id})" title="Visualizar/Imprimir">üìÑ</button>
                            <button class="btn-icon btn-edit" onclick="event.stopPropagation(); editarChecklist(${c.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-icon btn-delete" onclick="event.stopPropagation(); deletarChecklist(${c.id})" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Etapa 1: Seleciona tipo de m√°quina
        function selecionarTipo(tipo) {
            tipoSelecionado = tipo;

            // Atualiza t√≠tulo
            const titulos = {
                colhedora: 'Selecione a Colhedora',
                trator: 'Selecione o Trator',
                transbordo: 'Selecione o Transbordo'
            };
            document.getElementById('tituloMaquinas').textContent = titulos[tipo];

            // Preenche lista de m√°quinas
            const frota = App.getMaquinas();
            const maquinas = frota[tipo + 's'] || frota[tipo + 'es'] || [];
            const lista = document.getElementById('listaMaquinas');
            lista.innerHTML = '';

            // Busca rascunhos pendentes
            const rascunhos = DB.listarRascunhos();

            if (maquinas.length === 0) {
                lista.innerHTML = `
                    <div class="empty-state" style="grid-column: span 2;">
                        <div class="icon">üöú</div>
                        <h3>Nenhuma m√°quina cadastrada</h3>
                        <p><a href="frota.html" style="color: var(--accent-secondary);">Clique aqui para adicionar</a></p>
                    </div>
                `;
                return;
            }

            maquinas.forEach(m => {
                const card = document.createElement('div');
                card.className = 'machine-card';
                card.onclick = () => selecionarMaquina(m);

                const temRascunho = rascunhos[m.id];

                card.innerHTML = `
                    ${temRascunho ? '<span class="pending-badge">PENDENTE</span>' : ''}
                    <div class="machine-icon">${App.getIconeMaquina(m.tipo)}</div>
                    <div class="machine-name">${m.nome}</div>
                `;
                lista.appendChild(card);
            });

            // Mostra etapa 2
            document.getElementById('etapa1').classList.add('hidden');
            document.getElementById('etapa2').classList.remove('hidden');
        }

        // Etapa 2: Seleciona m√°quina espec√≠fica
        function selecionarMaquina(maquina) {
            maquinaSelecionada = maquina;
            modoEdicaoId = null;

            // Atualiza header da etapa 3
            document.getElementById('iconeMaquinaSelecionada').textContent = App.getIconeMaquina(maquina.tipo);
            document.getElementById('nomeMaquinaSelecionada').textContent = maquina.nome;
            document.getElementById('modeloMaquinaSelecionada').textContent = maquina.modelo;
            document.getElementById('modoEdicao').textContent = '';

            // Verifica se h√° rascunho pendente
            const rascunho = DB.buscarRascunho(maquina.id);
            if (rascunho) {
                if (confirm(`H√° um checklist pendente desta m√°quina (${new Date(rascunho.ultimaAtualizacao).toLocaleString('pt-BR')}). Deseja continuar de onde parou?`)) {
                    carregarRascunho(rascunho);
                } else {
                    DB.removerRascunho(maquina.id);
                    carregarChecklist();
                }
            } else {
                carregarChecklist();
            }

            // Mostra etapa 3
            document.getElementById('etapa2').classList.add('hidden');
            document.getElementById('etapa3').classList.remove('hidden');
        }

        // Carrega rascunho salvo
        function carregarRascunho(rascunho) {
            const config = CHECKLIST_ITEMS[tipoSelecionado];
            if (!config) return;

            const container = document.getElementById('categoriasChecklist');
            container.innerHTML = '';

            // Restaura estado dos itens
            itensChecklist = {};

            config.categorias.forEach(cat => {
                const catDiv = document.createElement('div');
                catDiv.className = 'card';
                catDiv.innerHTML = `
                    <h4 class="section-title" style="margin-bottom: 1rem;">
                        <span class="icon">${cat.icone}</span>
                        ${cat.nome}
                    </h4>
                    <div class="checklist-items" id="cat-${cat.nome.replace(/\s/g, '')}">
                        ${cat.itens.map(item => {
                    // Busca estado salvo no rascunho
                    const itemSalvo = rascunho.itens?.find(i => i.id === item.id) || { status: null, obs: '', fotos: [] };
                    itensChecklist[item.id] = itemSalvo;

                    const isChecked = itemSalvo.status === 'ok';
                    const isProblem = itemSalvo.status === 'problema';

                    return `
                                <div class="checklist-item" id="item-${item.id}">
                                    <div class="checklist-checkbox ${isChecked ? 'checked' : ''} ${isProblem ? 'problem' : ''}" onclick="toggleItem('${item.id}', this)">
                                        <span class="check-icon">${isProblem ? '!' : '‚úì'}</span>
                                    </div>
                                    <div class="checklist-content">
                                        <div class="checklist-title">${item.nome}</div>
                                        <div class="checklist-description">${item.descricao}</div>
                                        <div class="checklist-actions">
                                            <button class="checklist-btn" onclick="marcarProblema('${item.id}')">
                                                ‚ö†Ô∏è Problema
                                            </button>
                                            <button class="checklist-btn" onclick="abrirModalFoto('${item.id}')">
                                                üì∑ Foto
                                            </button>
                                            <button class="checklist-btn" onclick="abrirModalObs('${item.id}', '${item.nome}')">
                                                üìù Obs
                                            </button>
                                            <button class="checklist-btn" onclick="imprimirItem('${item.id}', '${item.nome}', '${item.descricao}')" style="background: var(--accent-secondary);">
                                                üñ®Ô∏è PDF
                                            </button>
                                        </div>
                                        <div class="obs-preview ${itemSalvo.obs ? '' : 'hidden'}" id="obs-${item.id}" style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--status-warning);">
                                            ${itemSalvo.obs ? 'üìù ' + itemSalvo.obs : ''}
                                        </div>
                                        <div class="fotos-preview" id="fotos-${item.id}" style="margin-top: 0.5rem;">
                                            ${itemSalvo.fotos?.length ? `
                                                <div class="photo-gallery">
                                                    ${itemSalvo.fotos.map((f, i) => `
                                                        <div class="photo-thumb">
                                                            <img src="${f.data}" alt="Foto ${i + 1}">
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
                container.appendChild(catDiv);
            });

            // Restaura observa√ß√µes gerais
            document.getElementById('observacoesGerais').value = rascunho.observacoesGerais || '';

            atualizarProgresso();
            iniciarAutoSave();
        }

        // Carrega checklist baseado no tipo
        function carregarChecklist() {
            const config = CHECKLIST_ITEMS[tipoSelecionado];
            if (!config) return;

            const container = document.getElementById('categoriasChecklist');
            container.innerHTML = '';

            // Inicializa estado dos itens
            itensChecklist = {};

            config.categorias.forEach(cat => {
                const catDiv = document.createElement('div');
                catDiv.className = 'card';
                catDiv.innerHTML = `
          <h4 class="section-title" style="margin-bottom: 1rem;">
            <span class="icon">${cat.icone}</span>
            ${cat.nome}
          </h4>
          <div class="checklist-items" id="cat-${cat.nome.replace(/\s/g, '')}">
            ${cat.itens.map(item => {
                    itensChecklist[item.id] = { status: null, obs: '', fotos: [] };
                    return `
                <div class="checklist-item" id="item-${item.id}">
                  <div class="checklist-checkbox" onclick="toggleItem('${item.id}', this)">
                    <span class="check-icon">‚úì</span>
                  </div>
                  <div class="checklist-content">
                    <div class="checklist-title">${item.nome}</div>
                    <div class="checklist-description">${item.descricao}</div>
                    <div class="checklist-actions">
                      <button class="checklist-btn" onclick="marcarProblema('${item.id}')">
                        ‚ö†Ô∏è Problema
                      </button>
                      <button class="checklist-btn" onclick="abrirModalFoto('${item.id}')">
                        üì∑ Foto
                      </button>
                      <button class="checklist-btn" onclick="abrirModalObs('${item.id}', '${item.nome}')">
                        üìù Obs
                      </button>
                      <button class="checklist-btn" onclick="imprimirItem('${item.id}', '${item.nome}', '${item.descricao}')" style="background: var(--accent-secondary);">
                        üñ®Ô∏è PDF
                      </button>
                    </div>
                    <div class="obs-preview hidden" id="obs-${item.id}" style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--status-warning);"></div>
                    <div class="fotos-preview" id="fotos-${item.id}" style="margin-top: 0.5rem;"></div>
                  </div>
                </div>
              `;
                }).join('')}
          </div>
        `;
                container.appendChild(catDiv);
            });

            atualizarProgresso();
            iniciarAutoSave();
        }

        // Inicia auto-save
        function iniciarAutoSave() {
            if (autoSaveTimer) clearInterval(autoSaveTimer);
            autoSaveTimer = setInterval(() => {
                if (maquinaSelecionada && !modoEdicaoId) {
                    salvarRascunhoAuto();
                }
            }, 30000); // Auto-save a cada 30 segundos
        }

        // Salva rascunho automaticamente
        function salvarRascunhoAuto() {
            const rascunho = {
                maquinaId: maquinaSelecionada.id,
                maquinaNome: maquinaSelecionada.nome,
                tipo: tipoSelecionado,
                itens: Object.entries(itensChecklist).map(([id, item]) => ({
                    id,
                    ...item
                })),
                observacoesGerais: document.getElementById('observacoesGerais').value
            };
            DB.salvarRascunho(rascunho);

            // Mostra indicador
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        // Salva rascunho manualmente
        function salvarRascunhoManual() {
            salvarRascunhoAuto();
            App.showToast('Rascunho salvo! Voc√™ pode continuar depois.', 'success');
        }

        // Toggle item OK
        function toggleItem(itemId, checkbox) {
            const item = itensChecklist[itemId];

            if (item.status === 'ok') {
                item.status = null;
                checkbox.classList.remove('checked');
            } else {
                item.status = 'ok';
                checkbox.classList.remove('problem');
                checkbox.classList.add('checked');
                checkbox.querySelector('.check-icon').textContent = '‚úì';
            }

            atualizarProgresso();
        }

        // Marca como problema
        function marcarProblema(itemId) {
            const item = itensChecklist[itemId];
            const checkbox = document.querySelector(`#item-${itemId} .checklist-checkbox`);

            if (item.status === 'problema') {
                item.status = null;
                checkbox.classList.remove('problem');
                checkbox.querySelector('.check-icon').textContent = '‚úì';
            } else {
                item.status = 'problema';
                checkbox.classList.remove('checked');
                checkbox.classList.add('problem');
                checkbox.querySelector('.check-icon').textContent = '!';

                // Abre modal de observa√ß√£o automaticamente
                abrirModalObs(itemId, document.querySelector(`#item-${itemId} .checklist-title`).textContent);
            }

            atualizarProgresso();
        }

        // Atualiza barra de progresso
        function atualizarProgresso() {
            const total = Object.keys(itensChecklist).length;
            const preenchidos = Object.values(itensChecklist).filter(i => i.status !== null).length;

            document.getElementById('progressoTexto').textContent = `${preenchidos} / ${total}`;
            document.getElementById('progressoBarra').style.width = `${(preenchidos / total) * 100}%`;
        }

        // Modal de Foto
        function abrirModalFoto(itemId) {
            itemFotoAtual = itemId;
            fotoAtualBase64 = null;
            document.getElementById('fotoPreview').innerHTML = '<span>Nenhuma foto</span>';
            document.getElementById('fotoDescricao').value = '';
            document.getElementById('modalFoto').classList.add('active');
        }

        function fecharModalFoto() {
            document.getElementById('modalFoto').classList.remove('active');
            itemFotoAtual = null;
        }

        async function tirarFoto() {
            try {
                const foto = await App.capturarFoto();
                fotoAtualBase64 = await App.comprimirImagem(foto);
                document.getElementById('fotoPreview').innerHTML = `<img src="${fotoAtualBase64}" alt="Foto">`;
            } catch (error) {
                App.showToast('Erro ao capturar foto', 'error');
            }
        }

        function salvarFoto() {
            if (!fotoAtualBase64) {
                App.showToast('Tire uma foto primeiro', 'warning');
                return;
            }

            const descricao = document.getElementById('fotoDescricao').value;

            itensChecklist[itemFotoAtual].fotos.push({
                data: fotoAtualBase64,
                descricao: descricao,
                timestamp: new Date().toISOString()
            });

            // Atualiza preview
            const previewContainer = document.getElementById(`fotos-${itemFotoAtual}`);
            previewContainer.innerHTML = `
        <div class="photo-gallery">
          ${itensChecklist[itemFotoAtual].fotos.map((f, i) => `
            <div class="photo-thumb">
              <img src="${f.data}" alt="Foto ${i + 1}">
            </div>
          `).join('')}
        </div>
      `;

            fecharModalFoto();
            App.showToast('Foto salva!', 'success');
        }

        // Modal de Observa√ß√£o
        function abrirModalObs(itemId, itemNome) {
            itemObsAtual = itemId;
            document.getElementById('labelItemObs').textContent = itemNome;
            document.getElementById('textoObs').value = itensChecklist[itemId].obs || '';
            document.getElementById('modalObs').classList.add('active');
        }

        function fecharModalObs() {
            document.getElementById('modalObs').classList.remove('active');
            itemObsAtual = null;
        }

        function salvarObs() {
            const obs = document.getElementById('textoObs').value;
            itensChecklist[itemObsAtual].obs = obs;

            // Atualiza preview
            const obsPreview = document.getElementById(`obs-${itemObsAtual}`);
            if (obs) {
                obsPreview.textContent = `üìù ${obs}`;
                obsPreview.classList.remove('hidden');
            } else {
                obsPreview.classList.add('hidden');
            }

            fecharModalObs();
            App.showToast('Observa√ß√£o salva!', 'success');
        }

        // Voltar etapa
        function voltarEtapa(etapa) {
            // Salva rascunho ao sair
            if (maquinaSelecionada && !modoEdicaoId) {
                salvarRascunhoAuto();
            }

            document.getElementById('etapa1').classList.add('hidden');
            document.getElementById('etapa2').classList.add('hidden');
            document.getElementById('etapa3').classList.add('hidden');
            document.getElementById(`etapa${etapa}`).classList.remove('hidden');

            if (etapa === 1) {
                carregarHistorico();
            }
        }

        // Finaliza checklist
        async function finalizarChecklist() {
            // Verifica se todos os itens foram preenchidos
            const naoPreenchidos = Object.values(itensChecklist).filter(i => i.status === null).length;

            if (naoPreenchidos > 0) {
                if (!confirm(`Ainda h√° ${naoPreenchidos} itens n√£o verificados. Deseja continuar mesmo assim?`)) {
                    return;
                }
            }

            // Monta objeto do checklist
            const checklist = {
                maquina: maquinaSelecionada.id,
                maquinaNome: maquinaSelecionada.nome,
                tipo: tipoSelecionado,
                data: new Date().toISOString(),
                itens: Object.entries(itensChecklist).map(([id, item]) => ({
                    id,
                    ...item
                })),
                observacoesGerais: document.getElementById('observacoesGerais').value
            };

            try {
                if (modoEdicaoId) {
                    // Atualiza checklist existente
                    checklist.id = modoEdicaoId;
                    await DB.atualizarChecklist(checklist);
                    App.showToast('Checklist atualizado com sucesso!', 'success');
                } else {
                    // Salva novo checklist
                    await DB.salvarChecklist(checklist);
                    // Remove rascunho
                    DB.removerRascunho(maquinaSelecionada.id);
                    App.showToast('Checklist salvo com sucesso!', 'success');
                }

                // Para auto-save
                if (autoSaveTimer) clearInterval(autoSaveTimer);

                // Volta para a tela inicial ap√≥s 1.5s
                setTimeout(() => {
                    voltarEtapa(1);
                }, 1500);
            } catch (error) {
                console.error('Erro ao salvar:', error);
                App.showToast('Erro ao salvar checklist', 'error');
            }
        }

        // Visualiza checklist para impress√£o
        async function visualizarChecklist(id) {
            const checklist = await DB.buscarChecklistPorId(id);
            if (!checklist) {
                App.showToast('Checklist n√£o encontrado', 'error');
                return;
            }

            const data = new Date(checklist.data);
            const config = CHECKLIST_ITEMS[checklist.tipo];

            // Conta resultados
            const totalItens = checklist.itens?.length || 0;
            const itensOk = checklist.itens?.filter(i => i.status === 'ok').length || 0;
            const itensProblema = checklist.itens?.filter(i => i.status === 'problema').length || 0;
            const itensPendente = totalItens - itensOk - itensProblema;

            // Agrupa itens por categoria
            let conteudoHtml = `
                <div class="print-header">
                    <div>
                        <h1>üìã Checklist de Manuten√ß√£o</h1>
                        <p class="print-header-info"><strong>${checklist.maquinaNome}</strong></p>
                    </div>
                    <div style="text-align: right;">
                        <p class="print-header-info">${data.toLocaleDateString('pt-BR')}</p>
                        <p class="print-header-info">${data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                </div>
                <div class="print-summary" style="display: flex; gap: 1rem; margin-bottom: 1rem; padding: 0.75rem; background: #f0f0f0; border-radius: 8px;">
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">‚úì ${itensOk}</div>
                        <div style="font-size: 0.8rem; color: #666;">OK</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">! ${itensProblema}</div>
                        <div style="font-size: 0.8rem; color: #666;">Problemas</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #6b7280;">? ${itensPendente}</div>
                        <div style="font-size: 0.8rem; color: #666;">Pendentes</div>
                    </div>
                </div>
            `;

            if (config) {
                config.categorias.forEach(cat => {
                    conteudoHtml += `<h2>${cat.icone} ${cat.nome}</h2>`;
                    cat.itens.forEach(item => {
                        const itemSalvo = checklist.itens?.find(i => i.id === item.id);
                        const status = itemSalvo?.status || 'pendente';
                        const statusIcon = status === 'ok' ? '‚úì' : (status === 'problema' ? '!' : '?');
                        const fotos = itemSalvo?.fotos || [];

                        conteudoHtml += `
                            <div class="print-item" style="margin-bottom: ${fotos.length > 0 ? '1rem' : '0'};">
                                <div class="status ${status}">${statusIcon}</div>
                                <div style="flex: 1;">
                                    <strong>${item.nome}</strong>
                                    <div style="font-size: 0.8rem; color: #888;">${item.descricao}</div>
                                    ${itemSalvo?.obs ? `<div class="obs">üìù ${itemSalvo.obs}</div>` : ''}
                                    ${fotos.length > 0 ? `
                                        <div class="print-photos" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                            ${fotos.map((foto, idx) => `
                                                <div style="flex: 0 0 auto;">
                                                    <img src="${foto.data}" alt="Foto ${idx + 1}" style="width: 200px; height: 150px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">
                                                    ${foto.descricao ? `<div style="font-size: 0.8rem; color: #666; max-width: 200px;">${foto.descricao}</div>` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                });
            }

            if (checklist.observacoesGerais) {
                conteudoHtml += `
                    <h2>üìù Observa√ß√µes Gerais</h2>
                    <p style="padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">${checklist.observacoesGerais}</p>
                `;
            }

            // Rodap√© com assinatura
            conteudoHtml += `
                <div class="print-footer" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #16213e;">
                    <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                        <div style="flex: 1; text-align: center; border-top: 1px solid #333; margin: 0 1rem; padding-top: 0.5rem;">
                            <strong>T√©cnico Respons√°vel</strong>
                        </div>
                        <div style="flex: 1; text-align: center; border-top: 1px solid #333; margin: 0 1rem; padding-top: 0.5rem;">
                            <strong>Supervisor</strong>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('printContent').innerHTML = conteudoHtml;
            document.getElementById('modalPrint').classList.add('active');
        }

        function fecharModalPrint() {
            document.getElementById('modalPrint').classList.remove('active');
        }

        // Imprime um item individual
        function imprimirItem(itemId, itemNome, itemDescricao) {
            const item = itensChecklist[itemId];
            if (!item) {
                App.showToast('Item n√£o encontrado', 'error');
                return;
            }

            const status = item.status || 'pendente';
            const statusIcon = status === 'ok' ? '‚úì' : (status === 'problema' ? '!' : '?');
            const statusColor = status === 'ok' ? '#10b981' : (status === 'problema' ? '#ef4444' : '#6b7280');
            const statusLabel = status === 'ok' ? 'OK' : (status === 'problema' ? 'PROBLEMA' : 'PENDENTE');
            const fotos = item.fotos || [];
            const data = new Date();

            let conteudoHtml = `
                <div class="print-header">
                    <div>
                        <h1>üìã Relat√≥rio de Verifica√ß√£o</h1>
                        <p class="print-header-info"><strong>${maquinaSelecionada?.nome || 'M√°quina'}</strong></p>
                    </div>
                    <div style="text-align: right;">
                        <p class="print-header-info">${data.toLocaleDateString('pt-BR')}</p>
                        <p class="print-header-info">${data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                </div>

                <div style="margin: 1.5rem 0; padding: 1rem; background: #f5f5f5; border-radius: 8px; border-left: 4px solid ${statusColor};">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: ${statusColor}; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold;">
                            ${statusIcon}
                        </div>
                        <div>
                            <h2 style="margin: 0; font-size: 1.25rem;">${itemNome}</h2>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">${itemDescricao}</p>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span style="display: inline-block; padding: 0.25rem 0.75rem; background: ${statusColor}; color: white; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
                            ${statusLabel}
                        </span>
                    </div>
                </div>
            `;

            // Observa√ß√µes
            if (item.obs) {
                conteudoHtml += `
                    <div style="margin: 1rem 0; padding: 1rem; background: #fff8e1; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem;">üìù Observa√ß√£o</h3>
                        <p style="margin: 0;">${item.obs}</p>
                    </div>
                `;
            }

            // Fotos
            if (fotos.length > 0) {
                conteudoHtml += `
                    <div style="margin: 1rem 0;">
                        <h3 style="margin: 0 0 0.75rem 0; font-size: 1rem;">üì∑ Fotos Anexadas (${fotos.length})</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                            ${fotos.map((foto, idx) => `
                                <div style="flex: 0 0 auto; text-align: center;">
                                    <img src="${foto.data}" alt="Foto ${idx + 1}" style="max-width: 250px; max-height: 200px; object-fit: contain; border-radius: 8px; border: 2px solid #ddd;">
                                    ${foto.descricao ? `<p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #666; max-width: 250px;">${foto.descricao}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Rodap√© com assinatura
            conteudoHtml += `
                <div class="print-footer" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #16213e;">
                    <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                        <div style="flex: 1; text-align: center; border-top: 1px solid #333; margin: 0 1rem; padding-top: 0.5rem;">
                            <strong>T√©cnico Respons√°vel</strong>
                        </div>
                        <div style="flex: 1; text-align: center; border-top: 1px solid #333; margin: 0 1rem; padding-top: 0.5rem;">
                            <strong>Supervisor</strong>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('printContent').innerHTML = conteudoHtml;
            document.getElementById('modalPrint').classList.add('active');
        }

        // Edita checklist existente
        async function editarChecklist(id) {
            const checklist = await DB.buscarChecklistPorId(id);
            if (!checklist) {
                App.showToast('Checklist n√£o encontrado', 'error');
                return;
            }

            // Configura modo de edi√ß√£o
            modoEdicaoId = id;
            tipoSelecionado = checklist.tipo;
            maquinaSelecionada = {
                id: checklist.maquina,
                nome: checklist.maquinaNome,
                tipo: checklist.tipo,
                modelo: checklist.tipo === 'colhedora' ? 'CH570' : ''
            };

            // Atualiza header
            document.getElementById('iconeMaquinaSelecionada').textContent = App.getIconeMaquina(checklist.tipo);
            document.getElementById('nomeMaquinaSelecionada').textContent = checklist.maquinaNome;
            document.getElementById('modeloMaquinaSelecionada').textContent = new Date(checklist.data).toLocaleDateString('pt-BR');
            document.getElementById('modoEdicao').textContent = '‚úèÔ∏è Modo Edi√ß√£o';

            // Carrega itens salvos
            const rascunho = {
                itens: checklist.itens,
                observacoesGerais: checklist.observacoesGerais
            };
            carregarRascunho(rascunho);

            // Mostra etapa 3
            document.getElementById('etapa1').classList.add('hidden');
            document.getElementById('etapa3').classList.remove('hidden');
        }

        // Deleta checklist
        async function deletarChecklist(id) {
            if (!confirm('Tem certeza que deseja excluir este checklist? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }

            try {
                await DB.deletarChecklist(id);
                App.showToast('Checklist exclu√≠do!', 'success');
                carregarHistorico();
            } catch (error) {
                App.showToast('Erro ao excluir', 'error');
            }
        }
    </script>
</body>

</html>